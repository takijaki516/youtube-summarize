import { getEmbeddings } from "@/lib/llm/embedding";
import { SimilarSearchResult } from "@/types/types";
import { drizzleClient, schema } from "@repo/database";
import pgvector from "pgvector";
import { sql } from "drizzle-orm";
import { NextResponse } from "next/server";

export async function POST(req: Request) {
  let pgQueryEmbedding = [
    -0.025719928, -0.031774357, -0.040946964, 0.041660897, 0.039800666,
    0.018544357, -0.08490847, 0.0025240027, 0.0053346194, -0.07333447,
    0.028197207, -0.0152793, 0.048621565, -0.012292164, 0.021473983,
    -0.014260924, -0.054112747, 0.082315296, -0.10367008, -0.028771412,
    -0.013895134, -0.0075154523, 0.034649994, -0.010138704, 0.024774095,
    0.0064978898, -0.037062198, -0.037799563, 0.00676448, -0.03026204,
    0.008447441, 0.025763733, 0.0074486616, 0.015392801, 0.009148515,
    0.018956978, -0.019069426, 0.055, -0.0053274743, -0.05975986, -0.09498451,
    0.018707277, -0.0154424, -0.016879516, 0.05582722, 0.0068568923,
    -0.016051136, -0.012793273, -0.010208006, -0.012846051, 0.03503978,
    -0.029436376, -0.042061336, -0.0502419, -0.015008038, 0.011462776,
    0.039920293, 0.0025771752, 0.059102107, -0.06801708, -0.012017001,
    -0.024770802, 0.008852239, -0.010694149, -0.0006239425, -0.075268194,
    -0.04686372, -0.07119182, -0.057769474, 0.05412562, -0.029615814,
    0.037942175, -0.013080792, 0.058020398, 0.044559535, -0.09802285,
    -0.01559092, -0.014953351, 0.02213278, 0.026654601, -0.02153379,
    0.0023536962, 0.12076163, 0.0072425953, 0.0014925112, 0.033353347,
    -0.013851591, 0.009510663, -0.034837425, -0.0019819406, 0.046603657,
    0.0040213685, 0.0154696535, -0.017906275, 0.12458961, -0.07091275,
    -0.004345852, -0.012068085, 0.04465287, 0.038756885, -0.0012868745,
    -0.03771357, -0.04086419, 0.01338865, 0.014039633, -0.026219426,
    0.015215611, -0.0045877085, -0.025625024, -0.005410074, -0.053786516,
    -0.020954128, -0.0760223, 0.0122171175, 0.013760048, -0.0035110393,
    0.016467627, 0.011780781, -0.048018333, 0.04950077, 0.009723367,
    0.019557172, -0.031041462, 0.05110024, -0.026101064, 0.0018915139,
    -0.005753448, -0.031907372, -0.046025768, -0.02775986, 0.01514531,
    -0.08222964, 0.050097253, -0.02829286, 0.011356714, -0.02805301,
    0.006757195, -0.09583834, 0.07538742, -0.004887806, -0.062960714,
    -0.0074344943, -0.042298283, 0.018987132, -0.0027489131, -0.06461883,
    -0.01527043, 0.032071304, -0.021951206, -0.010662462, -0.0077054617,
    -0.004553017, 0.018033009, -0.05723953, -0.04055107, -0.053248934,
    0.07267425, -0.029173212, 0.04787767, 0.0006113198, 0.043223437,
    -0.013499044, -0.005366538, 0.01962367, -0.024290185, 0.06568596,
    -0.012387355, 0.012047929, -0.010640983, 0.04839237, -0.05801326,
    0.039534435, 0.03736279, -0.08081475, -0.014182988, 0.0077620964,
    0.0046298634, -0.007985759, -0.013010049, -0.016310697, 0.0018054052,
    -0.017380191, -0.02702826, 0.029155856, -0.010243097, -0.010141778,
    0.008769173, 0.10296868, -0.038346507, 0.06283378, -0.040481552,
    -0.026739517, -0.058384117, -0.06570211, -0.034215525, -0.02842962,
    0.0261424, 0.0037441254, 0.011109997, -0.06666141, 0.019545179, 0.018624898,
    -0.03846862, -0.039359357, 0.052381735, 0.03290416, -0.03647764,
    -0.0057002585, 0.08066928, -0.026147865, -0.057709888, 0.003149731,
    -0.06272047, 0.002669312, -0.004696569, -0.009330976, 0.035933554,
    -0.0025457914, 0.072696604, -0.02038625, 0.044725336, 0.018825615,
    -0.006246447, 0.055519853, 0.0009832594, 0.0010595567, 0.006104997,
    -0.05627079, -0.042180106, -0.039532896, 0.003119104, 0.03474695,
    0.020350287, 0.06639783, -0.03129748, -0.016765974, -0.060475614,
    0.061287757, -0.056843042, -0.022712948, 0.04265809, -0.043843932,
    0.10401037, -0.045945667, 0.045030862, -0.025905449, 0.015846724,
    -0.0065817214, 0.012147139, -0.026293164, -0.021223037, 0.02715379,
    0.016166335, -0.002117092, 0.0042121336, -0.057859372, 0.03911941,
    -0.0056099673, -0.034483008, 0.016319407, 0.047755476, -0.032954816,
    0.016368939, -0.034356344, -0.017443357, -0.03797695, 0.026198382,
    0.009414529, 0.041916925, -0.00055657036, -0.006586145, -0.012312548,
    -0.019575983, -0.018131299, 0.010149232, -0.033757504, 0.0009555944,
    0.021515738, 0.004088446, 0.024270792, 0.04310669, 0.002275616,
    -0.045205392, -0.035992406, 0.015773172, -0.052998442, -0.0019700835,
    -0.0032943843, -0.014208794, -0.039563313, 0.04378027, 0.07819751,
    -0.021530988, -0.0382029, 0.03867256, 0.024154106, 0.020658383, 0.07014545,
    -0.003062587, 0.011945319, 0.018166741, 0.0138110025, 0.008340037,
    0.024417127, 0.026486808, -0.031547178, -0.052374423, 0.027312566,
    0.017784063, 0.12550065, 0.0038632653, 0.07568332, -0.06755968,
    -0.0021277575, -0.03901716, -0.031202402, -0.12058186, -0.037263602,
    -0.0038736407, 0.031444788, 0.01376006, 0.008764033, -0.018008059,
    -0.0054441574, 0.047343686, 0.0014461061, 0.016642464, 0.03467364,
    -0.025142595, 0.013860807, 0.018508712, 0.0018632406, 0.0033646843,
    0.0033760536, -0.022049394, -0.023249147, -0.027000807, 0.018261647,
    0.05630567, 0.040923234, 0.01198916, 0.013980039, 0.0065963254,
    -0.045265988, 0.01763765, -0.032108605, -0.006213158, -0.035523836,
    -0.02910217, 0.0020190075, -0.015236698, 0.008109319, 0.04366659,
    -0.04043525, -0.008867197, 0.016641319, -0.00022364392, -0.0015170551,
    0.009660317, -0.022445297, -0.0036336016, -0.005839637, -0.014380777,
    0.018013394, -0.06243896, -0.06401615, -0.045538533, 0.045926128,
    -0.021149583, -0.04086858, 0.017644348, 0.06505883, -0.044323586,
    -0.0068668392, 0.052249357, -0.046758756, 0.0020282527, 0.02171149,
    -0.013305978, -0.006000964, -0.042213626, -0.0090041375, -0.00793039,
    0.01634158, -0.027223114, 0.0047690035, 0.010521361, 0.058003485,
    -0.048796263, -0.0037950368, -0.017756674, 0.06013792, 0.005753388,
    0.018280279, -0.06020183, 0.00077322416, -0.046330877, 0.008970642,
    -0.039149556, -0.037554357, -0.0392287, 0.014331907, 0.078732125,
    -0.031639963, -0.010708982, -0.00740851, 0.08521344, -0.00952419,
    -0.019532664, 0.035550192, 0.019226236, 0.024716148, -0.017368652,
    0.016559945, -0.024945088, 0.0012969367, -0.017201206, -0.04188202,
    0.022430513, 0.041471142, -0.03429047, -0.0090006655, 0.050972555,
    0.0138707245, -0.034536142, -0.008461271, -0.0163392, -0.015157936,
    0.032216992, -0.029684633, 0.027065277, 0.055591807, 0.009630065,
    0.060272463, 0.0048068687, 0.023758963, 0.0053380495, -0.027191663,
    -0.004375659, -0.018444752, 0.011248466, -0.0866344, 0.019767603,
    0.068768665, -0.058157615, 0.0035726957, 0.005171703, 0.010393537,
    -0.04982711, -0.015591479, -0.0001580197, 0.010451354, 0.031201096,
    -0.011322777, -0.087803125, -0.004726196, -0.024268687, -0.010459941,
    -0.017293796, -0.057700653, -0.06875249, -0.018916834, 0.08431474,
    0.042573247, -0.012708234, 0.014444098, -0.004478705, 0.04415684,
    0.009686222, 0.0020076237, 0.008625863, 0.01698401, 0.026243623,
    0.016642073, -0.004223699, 0.00445215, 0.019267166, -0.015566113,
    -0.022433432, 0.0029758685, -0.045404896, 0.0009812214, 0.017015794,
    0.015988637, 0.04592703, -0.0025172315, 0.016263304, 0.022764547,
    -0.0019401013, 0.03579035, -0.076566726, 0.013392478, 0.00394637,
    -0.0063552493, -0.014910767, 0.009878975, 0.04798786, 0.00459497,
    -0.028620265, -0.00940672, 0.042539425, 0.00053053384, 0.015694156,
    -0.0108827315, -0.037492603, 0.0068221474, 0.02647257, -0.054680143,
    0.020845897, 0.008772178, 0.0040256823, -0.014480524, 0.019332897,
    -0.027803129, -0.06103894, 0.018296268, -0.03459303, 0.008062052,
    -0.07324543, -0.040315453, 0.039383993, 0.022044986, 0.025622884,
    -0.048617944, 0.041486092, -0.004822934, 0.01357511, -0.030330397,
    -0.033368144, 0.013610896, 0.0146095725, 0.061085775, 0.0414539,
    -0.0066184634, 0.019942585, -0.014365436, 0.0033198537, -0.015240456,
    -0.012344515, -0.021482114, 0.028171651, 0.019899307, 0.008176268,
    0.010396517, -0.0007164544, -0.05094733, -0.0058074896, 0.022828724,
    -0.03233463, 0.05021483, -0.08228263, -0.031120017, 0.0046042954,
    -0.06801703, 0.022679508, -0.046112493, -0.029425373, -0.022081248,
    -0.019398479, -0.060100112, -0.03718923, -0.052830115, 0.042729355,
    0.00329273, 0.034744248, 0.006859416, 0.0025338782, 0.009868631,
    -0.06176878, 0.017912349, -0.01515357, 0.03833228, 0.009540081,
    -0.037002113, 0.0074310526, 0.02623182, -0.030897515, 0.057341404,
    -0.0084374035, 0.0142088495, 0.027569028, 0.01856353, 0.05976137,
    0.039169993, -0.059231453, 0.025428204, 0.041718125, -0.025480166,
    -0.028949771, 0.048698645, 0.009212456, -0.015148062, 0.050279222,
    -0.04687153, 0.0046956283, -0.026035016, -0.053450428, 0.023266627,
    0.010802432, -0.020080946, 0.008450519, 0.0010758479, 0.056798,
    -0.0028247589, -0.015494038, -0.06116963, -0.0038524452, -0.044505756,
    0.032993812, -0.014248243, 0.016765518, 0.046344943, -0.021323854,
    -0.034091543, -0.106236264, -0.023462635, -0.10226065, -0.03508989,
    -0.048382908, 0.027861755, 0.045816544, -0.0022083754, -0.02429251,
    0.025985673, 0.002388353, 0.0018133975, 0.017563948, 0.017044617,
    0.046073314, -0.032521248, 0.0013760338, -0.054932665, 0.012788442,
    -0.023448264, -0.01701618, 0.02009766, -0.012282422, 0.0075081047,
    -0.02508369, -0.040967245, 0.036291435, -0.0028411339, 0.024388773,
    -0.010518902, 0.025477624, -0.01112775, -0.024458773, 0.026334312,
    0.009980433, 0.020632982, -0.0032764839, 0.04427476, -0.01537389,
    0.05168335, 0.000891161, -0.0047097863, -0.047105294, -0.020898422,
    -0.043285996, -0.029604439, 0.029687185, -0.077649266, 0.007998167,
    0.0700987, -0.05732129, -0.026179045, -0.009118892, 0.017161835, 0.07676131,
    -0.027616078, 0.025922934, 0.039028138, 0.022129854, 0.014661529,
    -0.021499462, 0.022307564, 0.04779336, 0.05921489, -0.03162826, 0.05114306,
    -0.0013209443, -0.07721367, 0.018078689, -0.04245159, 0.019371469,
    -0.0068009594, 0.045859445, -0.005859617, 0.08554494, -0.006438807,
    0.02738269, -0.036196735, -0.06468742, -0.0013684798, 0.018561378,
    0.032099612, 0.045465685, -0.0060389373, 0.03948708, -0.024025576,
    -0.039786972, -0.009454929, 0.0063235285, -0.004232659, 0.026604714,
    0.00042565336, 0.019187178, 0.05187109, 0.009484882, 0.03120207,
    -0.034074098, 0.007251024, 0.016067183, -0.033465248, -0.00076833914,
    0.017202348, -0.06478227, 0.022943417, -0.008489972, 0.033020657,
    -0.05643613, 0.0074102436, 0.015360188, 0.02003472, 0.0162645, 0.03356861,
    -0.02987277, -0.007223121, -0.04178443, 0.0414401, -0.003607682,
    -0.031659435, -0.021632655, -0.024956537, -0.022462403, 0.058657132,
    -0.025019484, 0.03130466, 0.023811, 0.0029022675, -0.031728942,
    -0.057988945, -0.12807007, -0.042298276, 0.016566614, 0.015413825,
    0.012500621, -0.008184381, -0.039586116, -0.020902418, -0.047993254,
    0.0075817173, 0.00013521244, -0.058458578, -0.0022183307, -0.007226099,
    0.051614717, -0.025496457, -0.017305886, 0.016727598, -0.004118858,
    -0.014028209, -0.03861971, 0.028241439, -0.019691205, -0.020147791,
    0.031665742, 0.009947683,
  ];
  let videoId = 10;
  let clientUUID = "75cd8446-4661-4db0-92a8-76f207a32af1";
  pgQueryEmbedding = pgvector.toSql(pgQueryEmbedding);

  const result = await drizzleClient.execute(sql`
    SELECT text as text_field, start as start_offset, lang, 1 - (embedding <=> ${pgQueryEmbedding}) AS cosine_similarity
    FROM ${schema.tempEmbeddingsSchema}
    WHERE ${schema.tempEmbeddingsSchema.videoId} = ${videoId} AND ${schema.tempEmbeddingsSchema.clientUUID} = ${clientUUID}
    ORDER BY cosine_similarity DESC
      LIMIT ${1}
    `); // FIXME: maybe better infer possible?

  console.log("🚀 ~ POST ~ result:", result.rows);

  const getEmbedding = await getEmbeddings(["test1", "test2"]);
  return NextResponse.json({ data: getEmbedding });
}
